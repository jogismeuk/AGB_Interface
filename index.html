<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Above Ground Biomass Estimate</title>

  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 12px 16px;
      border-radius: 6px;
      max-width: 300px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    }

    .map-overlay h1 {
      margin: 0 0 6px;
      font-size: 18px;
      color: #1b4332;
    }

    .map-overlay p {
      margin: 0;
      font-size: 13px;
      color: #444;
    }

    .legend {
      background: white;
      padding: 8px 12px;
      font-size: 12px;
      line-height: 18px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="map-overlay">
  <h1>Above Ground Biomass</h1>
  <p>Polygons styled by AGB values (kg or t depending on your field).</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

  // ------------------------------------------------------------
  // Map setup
  // ------------------------------------------------------------
  const map = L.map('map').setView([54, -2], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);


  // ------------------------------------------------------------
  // Fixed 100 kg Class Styling
  // ------------------------------------------------------------
  function getColor(d) {
    return d >= 1000 ? '#002d13' :
           d >= 900  ? '#00441b' :
           d >= 800  ? '#005a24' :
           d >= 700  ? '#006d2c' :
           d >= 600  ? '#238b45' :
           d >= 500  ? '#41ab5d' :
           d >= 400  ? '#74c476' :
           d >= 300  ? '#a1d99b' :
           d >= 200  ? '#c7e9c0' :
           d >= 100  ? '#e5f5e0' :
                       '#f7fcf5';
  }

  function style(feature) {
    return {
      fillColor: getColor(feature.properties.AGB),
      fillOpacity: 0.9,
      color: 'black',
      weight: 0.6
    };
  }


  // ------------------------------------------------------------
  // Load GeoJSON
  // ------------------------------------------------------------
  const geojsonUrl = 'AGBmap2Simpl.geojson?v=' + new Date().getTime();

  fetch(geojsonUrl)
    .then(r => r.json())
    .then(data => {

      const geoLayer = L.geoJSON(data, {
        style: style,
        onEachFeature: (feature, layer) => {
          layer.bindPopup(
            `<strong>AGB:</strong> ${feature.properties.AGB} kg`
          );
        }
      }).addTo(map);

      map.fitBounds(geoLayer.getBounds());


      // --------------------------------------------------------
      // Legend
      // --------------------------------------------------------
      const legend = L.control({ position: 'bottomright' });

      legend.onAdd = function () {

        const div = L.DomUtil.create('div', 'legend');

        const grades = [0,100,200,300,400,500,600,700,800,900,1000];

        for (let i = 0; i < grades.length; i++) {

          div.innerHTML +=
            '<i style="background:' + getColor(grades[i] + 1) +
            '; width:18px; height:18px; display:inline-block; margin-right:6px;"></i> ' +
            grades[i] +
            (grades[i + 1] ? '&ndash;' + grades[i + 1] + ' kg<br>' : '+ kg');
        }

        return div;
      };

      legend.addTo(map);

    })
    .catch(err => console.error('Error loading GeoJSON', err));

</script>

</body>
</html>


