<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Above Ground Biomass Estimate</title>

  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 12px 16px;
      border-radius: 6px;
      max-width: 300px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    }

    .map-overlay h1 {
      margin: 0 0 6px;
      font-size: 18px;
      color: #1b4332;
    }

    .map-overlay p {
      margin: 0;
      font-size: 13px;
      color: #444;
    }

    .legend {
      background: white;
      padding: 8px 12px;
      font-size: 12px;
      line-height: 18px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="map-overlay">
  <h1>Above Ground Biomass</h1>
  <p>Polygons styled by AGB values (kg or t depending on your field).</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

  // ------------------------------------------------------------
  // Map setup
  // ------------------------------------------------------------
  const map = L.map('map').setView([54, -2], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);


  // ------------------------------------------------------------
  // CHM Overlay (must be exported as GeoTIFF or image tile)
  // ------------------------------------------------------------

  // OPTION 1: If you exported CHM as a PNG with known bounds
  const chmBounds = [[53.5, -3.0], [54.5, -1.0]];  // <-- REPLACE with real bounds

  const chmLayer = L.imageOverlay(
    'CHM.png',   // <-- replace with your raster filename
    chmBounds,
    { opacity: 0.5 }
  );

  chmLayer.addTo(map);


  // ------------------------------------------------------------
  // GeoJSON source (cache safe)
  // ------------------------------------------------------------
  const geojsonUrl = 'AGBmap2Simpl.geojson?v=' + new Date().getTime();


  // ------------------------------------------------------------
  // Dark Green 10-Level Classification
  // ------------------------------------------------------------
  function getColor(value, breaks) {
    const colors = [
      '#edf8e9',
      '#c7e9c0',
      '#a1d99b',
      '#74c476',
      '#41ab5d',
      '#238b45',
      '#006d2c',
      '#005a24',
      '#00441b',
      '#002d13'
    ];

    for (let i = 0; i < breaks.length - 1; i++) {
      if (value >= breaks[i] && value <= breaks[i+1]) {
        return colors[i];
      }
    }
    return colors[colors.length - 1];
  }


  fetch(geojsonUrl)
    .then(r => r.json())
    .then(data => {

      const values = data.features
        .map(f => f.properties.AGB)
        .filter(v => v !== null && !isNaN(v));

      const min = Math.min(...values);
      const max = Math.max(...values);

      // 10 equal interval breaks
      const step = (max - min) / 10;
      const breaks = [];
      for (let i = 0; i <= 10; i++) {
        breaks.push(min + (step * i));
      }

      const geoLayer = L.geoJSON(data, {

        style: feature => ({
          fillColor: getColor(feature.properties.AGB, breaks),
          fillOpacity: 0.9,
          color: 'black',
          weight: 0.5
        }),

        onEachFeature: (feature, layer) => {
          layer.bindPopup(
            `<strong>AGB:</strong> ${feature.properties.AGB}`
          );
        }

      }).addTo(map);

      map.fitBounds(geoLayer.getBounds());

      // --------------------------------------------------------
      // Legend (10 classes)
      // --------------------------------------------------------
      const legend = L.control({position: 'bottomright'});

      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');

        for (let i = 0; i < 10; i++) {
          div.innerHTML +=
            '<i style="background:' + getColor(breaks[i], breaks) + '; width:18px; height:18px; display:inline-block; margin-right:6px;"></i> ' +
            breaks[i].toFixed(1) + ' – ' + breaks[i+1].toFixed(1) +
            '<br>';
        }

        return div;
      };

      legend.addTo(map);

    })
    .catch(err => console.error('Error loading GeoJSON', err));

</script>

</body>
</html>

